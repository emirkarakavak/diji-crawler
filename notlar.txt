1) Yeni site eklerken (Ã¶rn: epinparasi)
Scraperâ€™Ä±n DBâ€™ye yazdÄ±ÄŸÄ± deÄŸerlerle birebir aynÄ± keyâ€™leri kullan.

a) SITE_LABELS (gÃ¶rÃ¼nen ad)

const SITE_LABELS = {
  gamesatis:  "GameSatÄ±ÅŸ",
  hesapcomtr: "HesapComTR",
  vatangame:  "VatanGame",
  bynogame:   "ByNoGame",
  perdigital: "PerDigital",
  epinparasi: "EpinParasÄ±",        // <â€” YENÄ°
};

b) SITE_ORDER (sekme sÄ±rasÄ±)

const SITE_ORDER = ["gamesatis", "hesapcomtr", "vatangame", "bynogame", "perdigital", "epinparasi"]; // <â€” YENÄ° SONA

c) Kategori listeleri (scraperâ€™Ä±n yazdÄ±ÄŸÄ± categoryName stringleri)

const MLBB_CATEGORIES = [
  // ...
  "epinparasi-mlbb-tr",           // <â€” YENÄ° (MLBB TR)
  "epinparasi-mlbb-global",       // <â€” YENÄ° (MLBB Global)
];

const PUBG_CATEGORIES = [
  // ...
  "epinparasi-pubgm-tr",          // <â€” varsa
  "epinparasi-pubgm-global",      // <â€” varsa
];


2) Mevcut siteye yeni kategori eklerken
Sadece ilgili diziye eklemen yeter:

const MLBB_CATEGORIES = [
  // mevcutlar...
  "gamesatis-mlbb-superpaket",   // <â€” yeni kategori Ã¶rneÄŸi
];

Scraperâ€™Ä±n categoryName olarak bunlardan birini yazdÄ±ÄŸÄ±ndan emin ol.


3) (Ä°leride) Yeni oyun eklemek istersen (Ã¶r: Free Fire)

SeÃ§enek A Ã§izgisinde kalacaksan bir oyun daha tanÄ±mlarsÄ±n:

// a) Yeni oyun kategorileri
const FREEFIRE_CATEGORIES = [
  "gamesatis-ff-tr", "gamesatis-ff-global",
  "hesap-ff-tr", "hesap-ff-global",
  // ... diÄŸer siteler
];

// b) Toplama dizi
const ALL_CATEGORIES = [...MLBB_CATEGORIES, ...PUBG_CATEGORIES, ...FREEFIRE_CATEGORIES];

// c) Oyun seti (oyunu ayÄ±rmak iÃ§in)
const MLBB_SET = new Set(MLBB_CATEGORIES);
const PUBG_SET  = new Set(PUBG_CATEGORIES);
const FF_SET    = new Set(FREEFIRE_CATEGORIES);

// d) View-model baÅŸlangÄ±cÄ±
const model = {
  mlbb:  { id: "mlbb",  label: "Mobile Legends", sites: {} },
  pubgm: { id: "pubgm", label: "Pubg Mobile",    sites: {} },
  ff:    { id: "ff",    label: "Free Fire",      sites: {} }, // <â€” yeni sekme
};

// e) itemâ€™Ä± oyuna yerleÅŸtirme
const cat = it.categoryName || "";
const game =
  MLBB_SET.has(cat) ? "mlbb" :
  PUBG_SET.has(cat) ? "pubgm" :
  FF_SET.has(cat)   ? "ff"   : null;

// f) En altta categories Ã§Ä±ktÄ±sÄ±
const categories = [
  { id: model.mlbb.id,  label: model.mlbb.label,  sites: finalizeSites(model.mlbb.sites) },
  { id: model.pubgm.id, label: model.pubgm.label, sites: finalizeSites(model.pubgm.sites) },
  { id: model.ff.id,    label: model.ff.label,    sites: finalizeSites(model.ff.sites) }, // <â€”
];


4) KÃ¼Ã§Ã¼k kontrol listesi

Scraperâ€™larda:

siteName â†’ SITE_LABELS/SITE_ORDER keyâ€™iyle aynÄ± slug (kÃ¼Ã§Ã¼k harf Ã¶neririm).

categoryName â†’ MLBB_CATEGORIES/PUBG_CATEGORIES dizilerindeki stringlerden biri.

Yeni site eklediÄŸinde sadece 3 yeri gÃ¼ncelliyorsun: SITE_LABELS, SITE_ORDER, ilgili CATEGORIES dizisi.

Yeni kategori eklediÄŸinde yalnÄ±zca ilgili CATEGORIES dizisi.

Not: Indexâ€™leri ekledin; Ã¼retimde bir kez await Item.syncIndexes() Ã§alÄ±ÅŸtÄ±rÄ±p logâ€™da â€œensuredâ€ gÃ¶rmen iyi olur.


KapanÄ±ÅŸta 5 minik â€œproductionâ€ Ã¶nerisi bÄ±rakÄ±yorum:

.env â†’ MONGO_URI, HEADLESS=true, TZ=Europe/Istanbul.

Cron: stagger et (Ã¶rn. bng 00, gamesatis 05, â€¦) ki aynÄ± anda yÃ¼klenmesin.

persist.jsâ€™te debug flagâ€™i kapalÄ± tut; sadece sorun olduÄŸunda aÃ§.

Item.syncIndexes()â€™i bir kez deploy sonrasÄ± Ã§alÄ±ÅŸtÄ±rÄ±p logla.

Health check: /healthz â†’ Mongo ping + son cron run timestamp.

TakÄ±ldÄ±ÄŸÄ±n yerde yaz, hÄ±zlÄ±ca Ã§Ã¶zeriz. ðŸ™Œ


// cronTasks/kabasakalonline.js
const puppeteer = require("puppeteer");
const UserAgent = require("user-agents");
const { upsertAndArchive } = require("../lib/persist");

/**
 * tasks: [{ url: string, categoryName: string }, ...]
 * Ã–rnek Ã§aÄŸrÄ±:
 * [
 *   { url: 'https://kabasakalonline.com/urunler/108/pubg-mobile-uc-tr',        categoryName: 'PUBG UC TR' },
 *   { url: 'https://kabasakalonline.com/urunler/127/mobile-legends-elmas-tr',  categoryName: 'MLBB Elmas TR' },
 *   { url: 'https://kabasakalonline.com/urunler/239/mobile-legends-global-elmas', categoryName: 'MLBB Elmas Global' }
 * ]
 */
exports.run = async (tasks = []) => {
  if (!Array.isArray(tasks) || tasks.length === 0) {
    throw new Error("tasks boÅŸ. [{ url, categoryName }] ver.");
  }

  const browser = await puppeteer.launch({
    headless: true,
    args: [
      "--no-sandbox",
      "--disable-setuid-sandbox",
      "--disable-blink-features=AutomationControlled",
    ],
  });
  const page = await browser.newPage();

  // gerÃ§ekÃ§i UA + basit sertleÅŸtirme
  const ua = new UserAgent({ deviceCategory: "desktop" }).toString();
  await page.setUserAgent(ua);
  await page.setExtraHTTPHeaders({
    "Accept-Language": "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7",
  });
  await page.evaluateOnNewDocument(() => {
    Object.defineProperty(navigator, "webdriver", { get: () => false });
  });
  await page.setViewport({ width: 1366, height: 768 });
  page.setDefaultNavigationTimeout(120000);
  page.setDefaultTimeout(120000);

  const cleanMoneyToNumber = (txt) => {
    if (!txt) return null;
    // Binlik nokta -> sil, virgÃ¼l -> ondalÄ±k
    const s = String(txt)
      .replace(/[^\d.,-]/g, "")
      .replace(/\.(?=\d{3}(\D|$))/g, "")
      .replace(",", ".");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : null;
  };

  try {
    for (const { url, categoryName } of tasks) {
      if (!url || !categoryName) {
        console.warn("Task eksik, atlanÄ±yor:", { url, categoryName });
        continue;
      }

      console.log(`Scraping: ${url} -> ${categoryName}`);
      await page.goto(url, { waitUntil: "networkidle2", timeout: 120000 });

      // Basit koruma/ara sayfa tespiti (GEÃ‡MEK yok, sadece atlar)
      const challenged = await page.evaluate(() => {
        const t = document.title.toLowerCase();
        return (
          t.includes("checking your browser") ||
          t.includes("just a moment") ||
          !!document.querySelector('iframe[src*="challenge"], #challenge-form, .hcaptcha-box, .cf-challenge')
        );
      });
      if (challenged) {
        console.warn("DoÄŸrulama/koruma tespit edildi, atlandÄ±:", url);
        continue;
      }

      // Ä°Ã§erik gelene kadar bekle
      await page.waitForSelector("div#__next main", { timeout: 60000 }).catch(() => {});
      await page.waitForFunction(
        () =>
          document.querySelectorAll('div#__next h6.text-lg.line-clamp-1').length > 0 &&
          document.querySelectorAll('div#__next span.text-green-500.text-sm.font-bold').length > 0,
        { timeout: 60000 }
      ).catch(() => {});

      // BaÅŸlÄ±k + fiyat Ã§ek (basit eÅŸleÅŸtirme)
      const items = await page.evaluate(() => {
        const titles = Array.from(
          document.querySelectorAll('div#__next h6.text-lg.line-clamp-1')
        )
          .map(n => (n.textContent || "").trim())
          .filter(Boolean);

        const priceNodes = Array.from(
          document.querySelectorAll('div#__next span.text-green-500.text-sm.font-bold')
        )
          .map(n => (n.textContent || "").trim())
          .filter(Boolean);

        const results = [];
        const count = Math.min(titles.length, priceNodes.length);
        for (let i = 0; i < count; i++) {
          const title = titles[i];
          const raw = priceNodes[i];

          const priceText = raw.replace(/[^\d.,-]/g, "").trim(); // sembol yok
          const curMatch = raw.toUpperCase().match(/(â‚º|TL|TRY|USD|\$|EUR|â‚¬)/);
          const currency = curMatch ? curMatch[1] : "â‚º"; // default â‚º

          results.push({ title, priceText, currency });
        }
        return results;
      });

      if (!items || items.length === 0) {
        console.warn(`Kabasakal: Ã¼rÃ¼n bulunamadÄ± -> ${url}`);
        continue;
      }

      // DB: UPSERT + ARCHIVE
      for (const it of items) {
        const sellPriceStr = it.priceText?.trim();
        if (!sellPriceStr) {
          console.warn(`Fiyat boÅŸ, atlandÄ±: [${categoryName}] ${it.title}`);
          continue;
        }
        const sellPriceValue = cleanMoneyToNumber(sellPriceStr);

        try {
          await upsertAndArchive(
            {
              siteName: "kabasakalonline",
              categoryName,
              itemName: it.title,
              sellPrice: sellPriceStr,   // "189,99"
              sellPriceValue,            // 189.99
              currency: it.currency,     // "â‚º" | "TL" | ...
              url,
            },
            { archiveMode: "price-change" }
          );
          console.log(
            `Upsert: [${categoryName}] ${it.title} -> ${sellPriceStr} (${sellPriceValue ?? "NaN"} ${it.currency})`
          );
        } catch (err) {
          console.error(`Kaydetme hatasÄ±: [${categoryName}] ${it.title} ->`, err?.message || err);
        }
      }
    }
  } catch (err) {
    console.error("Kabasakal scrape hatasÄ±:", err?.message || err);
  } finally {
    await browser.close();
  }
};

const { run } = require('./cronTasks/kabasakalonline');

run([
  { url: 'https://kabasakalonline.com/urunler/108/pubg-mobile-uc-tr',           categoryName: 'PUBG UC TR' },
  { url: 'https://kabasakalonline.com/urunler/127/mobile-legends-elmas-tr',     categoryName: 'MLBB Elmas TR' },
  { url: 'https://kabasakalonline.com/urunler/239/mobile-legends-global-elmas', categoryName: 'MLBB Elmas Global' },
]);





///////////
// cronTasks/kabasakalonline.js
const puppeteer = require("puppeteer");
const UserAgent = require("user-agents");
const { upsertAndArchive } = require("../lib/persist");

/**
 * tasks: [{ url: string, categoryName: string }, ...]
 * Ã–rnek:
 * [
 *   { url: 'https://kabasakalonline.com/urunler/108/pubg-mobile-uc-tr',           categoryName: 'PUBG UC TR' },
 *   { url: 'https://kabasakalonline.com/urunler/127/mobile-legends-elmas-tr',     categoryName: 'MLBB Elmas TR' },
 *   { url: 'https://kabasakalonline.com/urunler/239/mobile-legends-global-elmas', categoryName: 'MLBB Elmas Global' }
 * ]
 */
exports.run = async (tasks = []) => {
  if (!Array.isArray(tasks) || tasks.length === 0) {
    throw new Error("tasks boÅŸ. [{ url, categoryName }] ver.");
  }

  const browser = await puppeteer.launch({
    headless: true,
    args: [
      "--no-sandbox",
      "--disable-setuid-sandbox",
      "--disable-blink-features=AutomationControlled",
    ],
  });

  const page = await browser.newPage();

  // gerÃ§ekÃ§i UA + kÃ¼Ã§Ã¼k sertleÅŸtirme
  const ua = new UserAgent({ deviceCategory: "desktop" }).toString();
  await page.setUserAgent(ua);
  await page.setExtraHTTPHeaders({
    "Accept-Language": "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7",
  });
  await page.evaluateOnNewDocument(() => {
    Object.defineProperty(navigator, "webdriver", { get: () => false });
  });
  await page.setViewport({ width: 1366, height: 768 });
  page.setDefaultNavigationTimeout(120000);
  page.setDefaultTimeout(120000);

  const cleanMoneyToNumber = (txt) => {
    if (!txt) return null;
    const s = String(txt)
      .replace(/[^\d.,-]/g, "")
      .replace(/\.(?=\d{3}(\D|$))/g, "") // 1.234.567,89 -> 1234567,89
      .replace(",", ".");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : null;
  };

  try {
    for (const { url, categoryName } of tasks) {
      if (!url || !categoryName) {
        console.warn("Task eksik, atlanÄ±yor:", { url, categoryName });
        continue;
      }

      console.log(`Scraping: ${url} -> ${categoryName}`);
      await page.goto(url, { waitUntil: "networkidle2", timeout: 120000 });

      // Basit doÄŸrulama/koruma tespiti (geÃ§meye Ã§alÄ±ÅŸma yok)
      const challenged = await page.evaluate(() => {
        const t = document.title.toLowerCase();
        return (
          t.includes("checking your browser") ||
          t.includes("just a moment") ||
          !!document.querySelector(
            'iframe[src*="challenge"], #challenge-form, .hcaptcha-box, .cf-challenge'
          )
        );
      });
      if (challenged) {
        console.warn("DoÄŸrulama/koruma tespit edildi, atlandÄ±:", url);
        continue;
      }

      // Ä°Ã§erik geldi mi?
      await page.waitForSelector("div#__next main", { timeout: 60000 }).catch(() => {});
      await page.waitForFunction(
        () =>
          document.querySelectorAll('div#__next h6.text-lg.line-clamp-1').length > 0 &&
          document.querySelectorAll('div#__next span.text-green-500.text-sm.font-bold').length > 0,
        { timeout: 60000 }
      ).catch(() => {});

      // === KART BAZLI EÅžLEÅžTÄ°RME ===
      const items = await page.evaluate(() => {
        const titleSel = 'div#__next h6.text-lg.line-clamp-1';
        const priceSel = 'div#__next span.text-green-500.text-sm.font-bold';

        const titles = Array.from(document.querySelectorAll(titleSel));
        const allPrices = Array.from(document.querySelectorAll(priceSel));

        const pickNearest = (titleEl, pricesScope) => {
          const candidates = pricesScope && pricesScope.length ? pricesScope : allPrices;
          if (!candidates.length) return null;

          const tb = titleEl.getBoundingClientRect();
          let best = null;
          let bestDist = Infinity;

          for (const p of candidates) {
            const pb = p.getBoundingClientRect();
            const dx = Math.abs((pb.left + pb.right) / 2 - (tb.left + tb.right) / 2);
            const dy = Math.abs((pb.top + pb.bottom) / 2 - (tb.top + tb.bottom) / 2);
            const d = Math.hypot(dx, dy);
            if (d < bestDist) {
              bestDist = d;
              best = p;
            }
          }
          return best;
        };

        const findPriceForTitle = (titleEl) => {
          // 1) BaÅŸlÄ±ktan yukarÄ± doÄŸru ebeveynlerde gez, bu ebeveynin Ä°Ã‡Ä°NDEki fiyatlardan en yakÄ±nÄ± al
          let node = titleEl;
          for (let depth = 0; depth < 10 && node && node !== document.body; depth++) {
            const pricesInThis = Array.from(node.querySelectorAll('span.text-green-500.text-sm.font-bold'));
            if (pricesInThis.length) {
              return pickNearest(titleEl, pricesInThis);
            }
            node = node.parentElement;
          }
          // 2) Fallback: tÃ¼m sayfadaki fiyatlardan en yakÄ±n olanÄ±
          return pickNearest(titleEl, null);
        };

        const results = [];
        const seen = new Set();

        for (const t of titles) {
          const title = (t.textContent || "").trim();
          if (!title) continue;

          const priceEl = findPriceForTitle(t);
          if (!priceEl) continue;

          const raw = (priceEl.textContent || "").trim();
          const priceText = raw.replace(/[^\d.,-]/g, "").trim(); // sembolsÃ¼z
          if (!priceText) continue;

          const curMatch = raw.toUpperCase().match(/(â‚º|TL|TRY|USD|\$|EUR|â‚¬)/);
          const currency = curMatch ? curMatch[1] : "â‚º";

          const key = `${title}|${priceText}`;
          if (seen.has(key)) continue;
          seen.add(key);

          results.push({ title, priceText, currency });
        }

        return results;
      });

      if (!items || items.length === 0) {
        console.warn(`Kabasakal: Ã¼rÃ¼n bulunamadÄ± -> ${url}`);
        continue;
      }

      // DB'ye yaz
      for (const it of items) {
        const sellPriceStr = it.priceText?.trim();
        if (!sellPriceStr) {
          console.warn(`Fiyat boÅŸ, atlandÄ±: [${categoryName}] ${it.title}`);
          continue;
        }
        const sellPriceValue = cleanMoneyToNumber(sellPriceStr);

        try {
          await upsertAndArchive(
            {
              siteName: "kabasakalonline",
              categoryName,
              itemName: it.title,
              sellPrice: sellPriceStr,   // "189,99"
              sellPriceValue,            // 189.99
              currency: it.currency,     // "â‚º" | "TL" | "TRY" | ...
              url,
            },
            { archiveMode: "price-change" }
          );
          console.log(
            `Upsert: [${categoryName}] ${it.title} -> ${sellPriceStr} (${sellPriceValue ?? "NaN"} ${it.currency})`
          );
        } catch (err) {
          console.error(`Kaydetme hatasÄ±: [${categoryName}] ${it.title} ->`, err?.message || err);
        }
      }
    }
  } catch (err) {
    console.error("Kabasakal scrape hatasÄ±:", err?.message || err);
  } finally {
    await browser.close();
  }
};
