<!doctype html>
<html lang="tr">
	<head>
		<meta charset="utf-8">
		<title>E-Pin Fiyatları (TR & Global)</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
		<style>
			body {
				background: #0f172a;
			}
			.card {
				border: none;
			}
			.price {
				font-variant-numeric: tabular-nums;
			}
			.nav-tabs,
			.nav-pills {
				flex-wrap: wrap;
			}
			.nav-tabs .nav-link,
			.nav-pills .nav-link {
				margin-bottom: 0.5rem;
			}
			.product-row {
				cursor: pointer;
			}
			.product-row:hover {
				background: rgba(255, 255, 255, 0.04);
			}
			#priceChart {
			max-height: 400px;   /* grafiğin yüksekliğini kısar */
			}
		</style>
	</head>
	<body class="text-light">
		<div class="container py-4">
			<div class="row justify-content-center">
				<div class="col-12 col-xl-11">
					<div class="card shadow-lg">
						<div
							class="card-body p-0">

							<!-- Başlık -->
							<div class="p-4 border-bottom bg-dark text-white rounded-top">
								<h1 class="h4 mb-1">Ürün Fiyatları</h1>
								<p class="mb-0 text-white-50">Üstten kategori seç; içeride site sekmeleri arasında gez.</p>
							</div>

							<!-- ANA KATEGORİ SEKMELERİ -->
							<ul class="nav nav-pills px-3 pt-3 bg-dark-subtle" id="categoryTabs" role="tablist">
								{% for cat in categories %}
									<li class="nav-item">
										<button class="btn btn-outline-danger me-2 {{ loop.first ? 'active' : '' }}" id="{{ cat.id }}-tab" data-bs-toggle="tab" data-bs-target="#{{ cat.id }}" type="button" role="tab">
											{{ cat.label }}
										</button>
									</li>
								{% endfor %}
							</ul>

							<div class="tab-content" id="categoryTabsContent">
								{% for cat in categories %}
									<div
										class="tab-pane fade {{ loop.first ? 'show active' : '' }}" id="{{ cat.id }}" role="tabpanel" aria-labelledby="{{ cat.id }}-tab">

										<!-- Şirket sekmeleri -->
										<ul class="nav nav-tabs px-3 pt-3 bg-body-tertiary" id="{{ cat.id }}-companyTabs" role="tablist">
											{% for site in cat.sites %}
												<li class="nav-item">
													<button class="nav-link {{ loop.first ? 'active' : '' }}" data-bs-toggle="tab" data-bs-target="#{{ cat.id }}-{{ site.id }}" type="button">
														{{ site.label }}
													</button>
												</li>
											{% endfor %}
										</ul>

										<div class="tab-content bg-body-tertiary" id="{{ cat.id }}-companyTabsContent">
											{% for site in cat.sites %}
												<div class="tab-pane fade {{ loop.first ? 'show active' : '' }}" id="{{ cat.id }}-{{ site.id }}">
													<div class="table-responsive">
														<table class="table table-hover table-borderless align-middle mb-0">
															<thead class="table-dark">
																<tr>
																	<th>Ürün</th>
																	<th class="text-end">TR Fiyatı (₺)</th>
																	<th class="text-end">Global (₺)</th>
																</tr>
															</thead>
															<tbody>
																{% if site.rows|length %}
																	{% for row in site.rows %}
																		<tr class="product-row" data-name="{{ row.name|e }}" data-site="{{ site.id|e }}">
																			<td>{{ row.name }}</td>
																			<td class="text-end price">{{ row.tr ?? '-' }}</td>
																			<td class="text-end price">{{ row.global ?? '-' }}</td>
																		</tr>
																	{% endfor %}
																{% else %}
																	<tr>
																		<td colspan="3" class="text-center text-muted">Kayıt yok</td>
																	</tr>
																{% endif %}
															</tbody>
														</table>
													</div>
												</div>
											{% endfor %}
										</div>
									</div>
								{% endfor %}
							</div>

							<div class="p-3 bg-dark text-white-50 rounded-bottom">
								<small>//</small>
							</div>

						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="priceModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-centered">
				<div class="modal-content bg-dark text-light">
					<div class="modal-header border-0">
						<h5 class="modal-title" id="priceModalTitle">Fiyat Geçmişi</h5>
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
					</div>
<div class="modal-body">
  <div class="row mb-3">
    <div class="col">
      <label for="startDate" class="form-label">Başlangıç</label>
      <input type="date" class="form-control" id="startDate">
    </div>
    <div class="col">
      <label for="endDate" class="form-label">Bitiş</label>
      <input type="date" class="form-control" id="endDate">
    </div>
    <div class="col-auto d-flex align-items-end">
      <button class="btn btn-danger" id="filterBtn">Filtrele</button>
    </div>
  </div>

  <canvas id="priceChart" height="120"></canvas>
  <div id="priceEmpty" class="text-center text-muted d-none">Kayıt yok</div>
</div>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const rows    = document.querySelectorAll('.product-row');
  const modalEl = document.getElementById('priceModal');
  const titleEl = document.getElementById('priceModalTitle');
  const emptyEl = document.getElementById('priceEmpty');
  const ctx     = document.getElementById('priceChart').getContext('2d');
  const filterBtn = document.getElementById('filterBtn');
  let chart;

  async function fetchPrices(name, start, end) {
    const params = new URLSearchParams();
    if (start) params.append('start', start);
    if (end)   params.append('end', end);
    const url = `/items/${encodeURIComponent(name)}/prices?` + params.toString();
    const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
    if (!res.ok) throw new Error('API hata: ' + res.status);
    return res.json();
  }

  function drawChart({ labels, data, currency }) {
    if (chart) chart.destroy();
    if (!data || !data.length) {
      emptyEl.classList.remove('d-none');
      return;
    }
    emptyEl.classList.add('d-none');
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: `Fiyat (${currency || '₺'})`,
          data,
          tension: 0.2,
          pointRadius: 2,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { x: { ticks: { maxRotation: 0 } }, y: { beginAtZero: false } },
        plugins: { legend: { display: true }, tooltip: { mode: 'index', intersect: false } }
      }
    });
  }

  rows.forEach(tr => {
    tr.addEventListener('click', async () => {
      const name = tr.getAttribute('data-name');
      titleEl.textContent = `Fiyat Geçmişi — ${name}`;
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value   = '';

      const modal = new bootstrap.Modal(modalEl);
      modal.show();

      try {
        const payload = await fetchPrices(name);
        drawChart(payload);
        modalEl.dataset.itemName = name; // filtre için sakla
      } catch (e) {
        console.error(e);
        emptyEl.textContent = 'Veri alınamadı';
        emptyEl.classList.remove('d-none');
        if (chart) chart.destroy();
      }
    });
  });

  modalEl.addEventListener('hidden.bs.modal', () => {
    if (chart) { chart.destroy(); chart = null; }
    emptyEl.classList.add('d-none');
    emptyEl.textContent = 'Kayıt yok';
  });

  filterBtn.addEventListener('click', async () => {
    const start = document.getElementById('startDate').value;
    const end   = document.getElementById('endDate').value;
    const name  = modalEl.dataset.itemName;
    if (!name) return;
    try {
      const payload = await fetchPrices(name, start, end);
      drawChart(payload);
    } catch (e) {
      console.error(e);
    }
  });
});
</script>


	</body>
</html>
